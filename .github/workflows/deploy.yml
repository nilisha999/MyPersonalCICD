# .github/workflows/deploy.yml
name: ⚙️ CI/CD Deployment to Personal Org

# Defines the trigger: runs on pushes to the 'main' branch
on:
  push:
    branches:
      - main

jobs:
  deploy_to_org:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code from Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli 
          sf --version

      - name: Authenticate using JWT (Non-interactive Login)
        run: |
          # Creates a temporary key file from the secret content for the CLI to use
          mkdir assets
          echo "${{ secrets.SF_JWT_KEY }}" > assets/server.key 
          
          # Authorizes the org using the stored secrets
          sf org login jwt --username ${{ secrets.SF_USERNAME }} --client-id ${{ secrets.SF_CONSUMER_KEY }} --jwt-key-file assets/server.key --set-default --alias personal-dev-org --no-prompt

      - name: Deploy Source to Org (Continuous Delivery)
        run: |
          # Deploys all source code in the force-app folder
          sf project deploy start --source-dir force-app --wait 10 --test-level RunLocalTests
          
      - name: Run All Local Apex Tests (Continuous Integration)
        run: |
          # Ensures code quality after deployment
          sf apex run test --code-coverage --output-dir test-results --wait 10
