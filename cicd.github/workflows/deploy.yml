# .github/workflows/deploy.yml
name: ðŸš€ Deploy to Production Org (Custom Field Deployment)

# Trigger: Runs only when changes are pushed to the 'main' branch
on:
  push:
    branches:
      - main

jobs:
  deploy_to_prod:
    runs-on: ubuntu-latest # The environment where the pipeline runs

    steps:
      # 1. Checkout Code: Get the metadata from the repository
      - name: Checkout Code from Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Install CLI: Install the Salesforce command-line interface
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      # 3. Authentication: Log in to the Production Org using JWT Secrets
      - name: Authenticate to Production Org
        run: |
          # Create a temporary key file from the stored GitHub Secret
          mkdir assets
          echo "${{ secrets.SF_JWT_KEY }}" > assets/server.key 
          
          # Use JWT for non-interactive login to the Production Org
          sf org login jwt --username ${{ secrets.SF_USERNAME }} --client-id ${{ secrets.SF_CONSUMER_KEY }} --jwt-key-file assets/server.key --set-default --alias prod-target --no-prompt

      # 4. Deployment (CD): Deploy the source code to the Production Org
      - name: Deploy Source to Production Org
        run: |
          # The deployment goes to the default org ('prod-target').
          # RunLocalTests is the best practice test level for deployments to Production.
          sf project deploy start --source-dir force-app --wait 15 --test-level RunLocalTests
          
      # 5. Testing (CI): Run tests to confirm quality (optional, but recommended)
      - name: Run All Local Apex Tests
        # This step runs again to capture detailed coverage data after deployment success
        run: |
          sf apex run test --code-coverage --output-dir test-results --wait 10 